<!DOCTYPE html>
<html>
    <body>
        <head>
            

            <title>Tarea 3 Connected</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
            <script type="text/JavaScript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" ></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
            <script src="plotly.min.js"></script>
            
            
        </head>

        <h1>State: Connected</h1>
        <a href="disconnect.html" type="button" class="btn btn-danger">Disconnect</a>
        <h2>Graphics</h2>
        <div id="charts"></div>

        
        <script type = "text/javascript">
            var socket = io("wss://le-18262636.bitzonte.com", {path: '/stocks'});
            var stocks = false;
            var exchanges = false;
            var dicc_stock = {};
            var dicc_exchange = {};
            var dicc_tablasStock = {};
            var volumen_total_mercado = 0;

            class Stock{
                constructor(ticker, company, country, quote) {
                    this.ticker = ticker;
                    this.max = 0;
                    this.min = Infinity;
                    this.last = 0;
                    this.variacion = 0;
                    this.company = company;
                    this.country = country;
                    this.quote = quote;
                    this.volumen_compra = 0;
                    this.volumen_venta = 0;
                    this.volumen_total = 0;
                    this.exchange = null
                }
            }

            function ModificarStocks(stock, value){
                if (value > stock.max){
                    stock.max = value;
                }
                if (value < stock.min){
                    stock.min = value;
                }
                if (stock.last != 0){
                    stock.variacion = (100*value/stock.last) -100;
                }
                stock.last = value;
            }

            class Exchange{
                constructor(name, exchange_ticker, country, address, listed_companies){
                    this.name = name;
                    this.exchange_ticker = exchange_ticker;
                    this.country = country;
                    this.address = address;
                    this.listed_companies = listed_companies;
                    this.v_compra = 0;
                    this.v_venta = 0;
                    this.v_total = 0;
                }
            }


            function Tabla_stock(stock){
                var titulo = "<tr><strong>"+ stock.company + " / " + stock.ticker + "</strong></tr>";
                var linea1 = "<tr>Volumen total transado: "+ stock.volumen_total + "</tr>";
                var linea2 = "<tr>Alto historico: "+ stock.max + "</tr>";
                var linea3 = "<tr>Bajo historico: "+ stock.min + "</tr>";
                var linea4 = "<tr>Ultimo precio: "+ stock.last + "</tr>";
                var linea5 = "<tr>Variacion porcentual: "+ stock.variacion + "</tr>";
                tabla = "<table>" + titulo + "<br>" + linea1 + "<br>" + linea2 + "<br>" + linea3 + "<br>" + linea4 + "<br>" + linea5 + "</table>" + "<br>";
                return tabla
            }

            //Funcion que emite al servidor
            function EmitExchanges(){
                socket.emit('EXCHANGES')
                socket.on('EXCHANGES', (data) => {
                    for (indice in data) {
                        info = data[indice];
                        var exc = new Exchange(info.name, info.exchange_ticker, info.country, info.address, info.listed_companies);
                        dicc_exchange[info.name]
                        for (i in info.listed_companies){
                            var name_company = info.listed_companies[i];
                            for (element in dicc_stock){
                                var stoc = dicc_stock[element];
                                if (stoc.company == name_company){
                                    stoc.exchange = exc;
                                }
                            }
                        }

                    }
                    exchanges = true;
                });
                
            }

            function EmitStocks(){
                socket.emit('STOCKS')
                socket.on('STOCKS', (data) => {
                    for (indice in data) {
                        info = data[indice];
                        $('#charts').append($('<div/>', { id: info.ticker}))
                        getGrafico(info.ticker);
                        var estok = new Stock(info.ticker, info.company_name, info.country, info.quote_base);
                        dicc_stock[info.ticker] = estok;
                        $('#charts').append($('<div/>', { id: info.company_name}))
                    }
                    EmitExchanges();

                    stocks = true;
                });
            }
    

            //Funciones que procesan los datos
            function processUpdate(data) {
                var ticker = data.ticker;
                var time = new Date(data.time);
                var value = data.value;
                ModificarStocks(dicc_stock[ticker], value);
                document.getElementById(dicc_stock[ticker].company).innerHTML = Tabla_stock(dicc_stock[ticker]);
                Plotly.extendTraces(ticker, { x:[[time]], y: [[value]] }, [0]);    //Funcion que actualiza el grafico                              
            }
            
            function processBuy(data) {
                var ticker = data.ticker;
                var time = data.time;
                var volume = data.volume;
                stok = dicc_stock[ticker];
                stok.volumen_compra += volume;
                stok.volumen_total += volume;
                stok.exchange.v_compra += volume;
                stok.exchange.v_total += volume;
                volumen_total_mercado += volume;
            }

            function processSell(data) {
                var ticker = data.ticker;
                var time = data.time;
                var volume = data.volume;
                stok = dicc_stock[ticker];
                stok.volumen_venta += volume;
                stok.volumen_total += volume;
                stok.exchange.v_venta += volume;
                stok.exchange.v_total += volume;
                volumen_total_mercado += volume;
            }


            //Funcion que recibe del servidor
            function WebSocketTest() {
                socket.on('UPDATE', (data) => {
                    console.log("Update");
                    console.log(data);
                    //Empieza a funcionar desde que se lee el stocks
                    if (stocks) {  
                        processUpdate(data);
                    }  
                });
                socket.on('BUY', (data) => {
                    console.log("Buy");
                    console.log(data);
                    if (stocks){
                        if (exchanges){
                            processBuy(data);
                        }
                    }
                });
                socket.on('SELL', (data) => {
                    console.log("Sell");
                    console.log(data);
                    if (stocks){
                        if (exchanges){
                            processSell(data);
                        }
                    }
                });
            }

            //Funcion que arma grafico vacio
            function getGrafico(ticker) {
                Plotly.plot(ticker,[{
                    title: {text: ticker},
                    x:[],
                    y:[],
                    type:'line'
                }],{
                title: {
                    text: ticker,
                    font: {
                    family: 'Courier New, monospace',
                    size: 24
                    },
                    xref: 'paper',
                    x: 0.05,
                },
                xaxis: {
                    title: {
                    text: 'Time',
                    font: {
                        family: 'Courier New, monospace',
                        size: 18,
                        color: '#7f7f7f'
                    }
                    },
                },
                yaxis: {
                    title: {
                    text: 'Value',
                    font: {
                        family: 'Courier New, monospace',
                        size: 18,
                        color: '#7f7f7f'
                    }
                    }
                }
                });
            }
            
        </script>


        <script type = "text/javascript">
            EmitStocks();


            WebSocketTest();

            

        </script>
    </body>
</html>