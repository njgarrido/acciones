<!DOCTYPE html>
<html>
    <body>
        <head>
            

            <title>Tarea 3 Connected</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
            <script type="text/JavaScript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js" ></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
            <script src="plotly.min.js"></script>
            
            
        </head>

        <h1>State: Connected</h1>
        <a href="file:///Users/usuario/Desktop/acciones/disconnect.html" type="button" class="btn btn-danger">Disconnect</a>
        <h2>Graphics</h2>
        <div id="charts"></div>
        <h2>Information</h2>

        
        <script type = "text/javascript">
            var socket = io("wss://le-18262636.bitzonte.com", {path: '/stocks'});
            var stocks = false;
            var exchanges = false;
            var dicc_stock = {};

            class Stock{
                constructor(ticker, company, country, quote) {
                    this.ticker = ticker;
                    this.max = 0;
                    this.min = Infinity;
                    this.last = 0;
                    this.variacion = 0;
                    this.company = company;
                    this.country = country;
                    this.quote = quote;
                    this.volumen_compra = 0;
                    this.volumen_venta = 0;
                }
            }

            function ModificarStocks(stock, value){
                if (value > stock.max){
                    stock.max = value;
                }
                if (value < stock.min){
                    stock.min = value;
                }
                if (stock.last != 0){
                    stock.variacion = (100*value/stock.last) -100;
                }
                stock.last = value;
            }


            //Funcion que emite al servidor
            function EmitExchanges(){
                socket.emit('EXCHANGES')
                socket.on('EXCHANGES', (data) => {
                    console.log("echange")
                    console.log(data);
                });
            }

            function EmitStocks(){
                socket.emit('STOCKS')
                socket.on('STOCKS', (data) => {
                    console.log("stocks");
                    console.log(data);
                    var length = data.length;
                    for (indice in data) {
                        info = data[indice];
                        $('#charts').append($('<div/>', { id: info.ticker}))
                        getGrafico(info.ticker);
                        var estok = new Stock(info.ticker, info.company_name, info.country, info.quote_base);
                        dicc_stock[info.ticker] = estok;
                    }
                    stocks = true;
                });
            }
    

            //Funciones que procesan los datos
            function processUpdate(data) {
                var ticker = data.ticker;
                var time = new Date(data.time);
                var value = data.value;
                ModificarStocks(dicc_stock[ticker], value);
                Plotly.extendTraces(ticker, { x:[[time]], y: [[value]] }, [0]);    //Funcion que actualiza el grafico                              
            }
            
            function processBuy(data) {
                var ticker = data.ticker;
                var time = data.time;
                var volume = data.volume;
                dicc_stock[ticker].volumen_compra += volume;
            }

            function processSell(data) {
                var ticker = data.ticker;
                var time = data.time;
                var volume = data.volume;
                dicc_stock[ticker].volumen_venta += volume;
            }


            //Funcion que recibe del servidor
            function WebSocketTest() {
                socket.on('UPDATE', (data) => {
                    console.log("Update");
                    console.log(data);
                    //Empieza a funcionar desde que se lee el stocks
                    if (stocks) {  
                        processUpdate(data);
                    }  
                });
                socket.on('BUY', (data) => {
                    console.log("Buy");
                    console.log(data);
                    if (stocks){
                        processBuy(data);
                    }
                });
                socket.on('SELL', (data) => {
                    console.log("Sell");
                    console.log(data);
                    if (stocks){
                        processSell(data);
                    }
                });
            }

            //Funcion que arma grafico vacio
            function getGrafico(ticker) {
                Plotly.plot(ticker,[{
                    title: {text: ticker},
                    x:[],
                    y:[],
                    type:'line'
                }],{
                title: {
                    text: ticker,
                    font: {
                    family: 'Courier New, monospace',
                    size: 24
                    },
                    xref: 'paper',
                    x: 0.05,
                },
                xaxis: {
                    title: {
                    text: 'Time',
                    font: {
                        family: 'Courier New, monospace',
                        size: 18,
                        color: '#7f7f7f'
                    }
                    },
                },
                yaxis: {
                    title: {
                    text: 'Value',
                    font: {
                        family: 'Courier New, monospace',
                        size: 18,
                        color: '#7f7f7f'
                    }
                    }
                }
                });
            }
            
        </script>


        <script type = "text/javascript">
            EmitExchanges();
            EmitStocks();


            WebSocketTest();

            

        </script>
    </body>
</html>